package main

import (
	"fmt"
	"time"
)

/*
ğŸ¯ å®æˆ˜é¡¹ç›® 2: API é™æµå™¨
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¼ çœŸå®åœºæ™¯:
ä½ åœ¨è°ƒç”¨ç¬¬ä¸‰æ–¹ APIï¼ˆæ¯”å¦‚å¾®ä¿¡ APIã€æ”¯ä»˜å® APIï¼‰ï¼Œä½†æ˜¯ï¼š
- API æœ‰è°ƒç”¨é¢‘ç‡é™åˆ¶ï¼šæ¯ç§’æœ€å¤š 5 æ¬¡è¯·æ±‚
- å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œä¼šè¢«å°ç¦è´¦å·
- ä½ çš„ç³»ç»Ÿéœ€è¦å¤„ç†å¤§é‡è¯·æ±‚ï¼Œå¿…é¡»åšé™æµ

è¿™å°±æ˜¯ "Rate Limiter"ï¼ˆé™æµå™¨ï¼‰çš„åº”ç”¨åœºæ™¯ï¼

ğŸ“š æ¶‰åŠçŸ¥è¯†ç‚¹:
âœ“ Channel - ä½œä¸ºä»¤ç‰Œæ¡¶
âœ“ Select - éé˜»å¡è·å–ä»¤ç‰Œ
âœ“ time.Ticker - å®šæ—¶å‘æ”¾ä»¤ç‰Œ
âœ“ Goroutine - åå°å‘æ”¾ä»¤ç‰Œ

ğŸ”¨ å®ç°æ€è·¯:
ä½¿ç”¨ "ä»¤ç‰Œæ¡¶ç®—æ³•"ï¼š
1. åˆ›å»ºä¸€ä¸ª channel ä½œä¸ºä»¤ç‰Œæ¡¶ï¼ˆå®¹é‡ = å…è®¸çš„çªå‘è¯·æ±‚æ•°ï¼‰
2. å¯åŠ¨ä¸€ä¸ª goroutineï¼Œå®šæ—¶å‘æ¡¶ä¸­æ”¾å…¥ä»¤ç‰Œ
3. æ¯æ¬¡è¯·æ±‚å‰ï¼Œä»æ¡¶ä¸­å–ä¸€ä¸ªä»¤ç‰Œ
4. å¦‚æœæ¡¶ç©ºäº†ï¼Œå°±å¿…é¡»ç­‰å¾…
*/

// RateLimiter é™æµå™¨
type RateLimiter struct {
	tokens   chan struct{} // ä»¤ç‰Œæ¡¶
	rate     time.Duration // å‘æ”¾ä»¤ç‰Œçš„æ—¶é—´é—´éš”
	capacity int           // æ¡¶çš„å®¹é‡ï¼ˆæœ€å¤šå­˜å¤šå°‘ä»¤ç‰Œï¼‰
	ticker   *time.Ticker  // å®šæ—¶å™¨
}

// NewRateLimiter åˆ›å»ºé™æµå™¨
// requestsPerSecond: æ¯ç§’å…è®¸å¤šå°‘è¯·æ±‚
// burstSize: çªå‘å®¹é‡ï¼ˆå…è®¸çŸ­æ—¶é—´å†…æœ‰å¤šå°‘çªå‘è¯·æ±‚ï¼‰
func NewRateLimiter(requestsPerSecond int, burstSize int) *RateLimiter {
	limiter := &RateLimiter{
		tokens:   make(chan struct{}, burstSize),
		rate:     time.Second / time.Duration(requestsPerSecond),
		capacity: burstSize,
	}

	// å…ˆå¡«æ»¡æ¡¶ï¼ˆå…è®¸ç¨‹åºå¯åŠ¨æ—¶ç«‹å³æœ‰ä¸€äº›è¯·æ±‚ï¼‰
	for i := 0; i < burstSize; i++ {
		limiter.tokens <- struct{}{}
	}

	// TODO(human): å¯åŠ¨å®šæ—¶å‘æ”¾ä»¤ç‰Œçš„ goroutine
	// æç¤ºï¼š
	// 1. åˆ›å»º time.Tickerï¼ŒæŒ‰ limiter.rate çš„é—´éš”å‘æ”¾ä»¤ç‰Œ
	// 2. åœ¨ goroutine ä¸­ç›‘å¬ tickerï¼Œæ¯æ¬¡è§¦å‘å°±å°è¯•å¾€ tokens æ”¾ä¸€ä¸ªä»¤ç‰Œ
	// 3. æ³¨æ„ï¼šæ¡¶å¯èƒ½æ»¡äº†ï¼Œè¦ç”¨ select + default å®ç°éé˜»å¡å‘é€
	//
	// ä»£ç ç»“æ„ï¼š
	// limiter.ticker = time.NewTicker(limiter.rate)
	// go func() {
	//     for range limiter.ticker.C {
	//         select {
	//         case limiter.tokens <- struct{}{}:
	//             // æˆåŠŸæ”¾å…¥ä»¤ç‰Œ
	//         default:
	//             // æ¡¶æ»¡äº†ï¼Œä¸¢å¼ƒè¿™ä¸ªä»¤ç‰Œ
	//         }
	//     }
	// }()

	// ä½ çš„ä»£ç ï¼š

	return limiter
}

// Allow å°è¯•è·å–ä¸€ä¸ªä»¤ç‰Œï¼ˆéé˜»å¡ï¼‰
// è¿”å› true è¡¨ç¤ºè·å–æˆåŠŸï¼Œå¯ä»¥æ‰§è¡Œè¯·æ±‚
// è¿”å› false è¡¨ç¤ºæ²¡æœ‰ä»¤ç‰Œï¼Œåº”è¯¥æ‹’ç»è¯·æ±‚
func (rl *RateLimiter) Allow() bool {
	// TODO(human): å®ç°éé˜»å¡è·å–ä»¤ç‰Œ
	// æç¤ºï¼šä½¿ç”¨ select + default
	//
	// select {
	// case <-rl.tokens:
	//     return true  // è·å–åˆ°ä»¤ç‰Œ
	// default:
	//     return false // æ²¡æœ‰ä»¤ç‰Œ
	// }

	// ä½ çš„ä»£ç ï¼š
	return false // å…ˆè¿”å› falseï¼Œç­‰ä½ å®ç°
}

// Wait ç­‰å¾…è·å–ä¸€ä¸ªä»¤ç‰Œï¼ˆé˜»å¡ï¼Œç›´åˆ°è·å–æˆåŠŸï¼‰
func (rl *RateLimiter) Wait() {
	// TODO(human): å®ç°é˜»å¡è·å–ä»¤ç‰Œ
	// æç¤ºï¼šç›´æ¥ä» channel è¯»å–å³å¯
	//
	// <-rl.tokens

	// ä½ çš„ä»£ç ï¼š

}

// Stop åœæ­¢é™æµå™¨
func (rl *RateLimiter) Stop() {
	if rl.ticker != nil {
		rl.ticker.Stop()
	}
}

// ============================================
// æ¨¡æ‹Ÿ API è°ƒç”¨
// ============================================

func callAPI(id int) {
	fmt.Printf("  âœ… [è¯·æ±‚ %2d] API è°ƒç”¨æˆåŠŸ (æ—¶é—´: %s)\n", id, time.Now().Format("15:04:05.000"))
}

func mainTest() {
	fmt.Println("ğŸ¯ å®æˆ˜é¡¹ç›® 2: API é™æµå™¨")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println()

	// åœºæ™¯ 1: ä¸é™æµï¼ˆçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼‰
	fmt.Println("ğŸ“ åœºæ™¯ 1: æ²¡æœ‰é™æµï¼ˆå±é™©ï¼ï¼‰")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("æ¨¡æ‹Ÿ: çŸ­æ—¶é—´å†…å‘é€ 10 ä¸ªè¯·æ±‚...")
	start := time.Now()
	for i := 1; i <= 10; i++ {
		callAPI(i)
	}
	fmt.Printf("âš ï¸  å®Œæˆæ—¶é—´: %v (æ‰€æœ‰è¯·æ±‚ç¬é—´å‘å‡ºï¼Œå®¹æ˜“è¢«å°ç¦ï¼)\n", time.Since(start))
	fmt.Println()

	time.Sleep(1 * time.Second)

	// åœºæ™¯ 2: ä½¿ç”¨é™æµå™¨ï¼ˆå®‰å…¨ï¼‰
	fmt.Println("ğŸ“ åœºæ™¯ 2: ä½¿ç”¨é™æµå™¨ (æ¯ç§’ 5 ä¸ªè¯·æ±‚ï¼Œçªå‘å®¹é‡ 3)")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

	// TODO(human): åˆ›å»ºé™æµå™¨
	// å‚æ•°ï¼šæ¯ç§’ 5 ä¸ªè¯·æ±‚ï¼Œçªå‘å®¹é‡ 3
	// ä½ çš„ä»£ç ï¼š
	limiter := NewRateLimiter(5, 3)
	defer limiter.Stop()

	fmt.Println("æ¨¡æ‹Ÿ: çŸ­æ—¶é—´å†…å‘é€ 10 ä¸ªè¯·æ±‚...")
	start = time.Now()

	// TODO(human): ä½¿ç”¨ Wait() æ–¹æ³•ï¼Œç¡®ä¿æ¯ä¸ªè¯·æ±‚éƒ½èƒ½æ‰§è¡Œï¼ˆä¼šè‡ªåŠ¨é™é€Ÿï¼‰
	// æç¤ºï¼š
	// for i := 1; i <= 10; i++ {
	//     limiter.Wait()  // ç­‰å¾…è·å–ä»¤ç‰Œ
	//     callAPI(i)
	// }

	// ä½ çš„ä»£ç ï¼š

	fmt.Printf("âœ… å®Œæˆæ—¶é—´: %v (è¯·æ±‚è¢«å¹³æ»‘å¤„ç†ï¼Œå®‰å…¨ï¼)\n", time.Since(start))
	fmt.Println()

	time.Sleep(1 * time.Second)

	// åœºæ™¯ 3: ä½¿ç”¨ Allow æ‹’ç»è¿‡å¤šè¯·æ±‚
	fmt.Println("ğŸ“ åœºæ™¯ 3: ä½¿ç”¨ Allow() - æ‹’ç»è¶…é™è¯·æ±‚")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

	limiter2 := NewRateLimiter(5, 3)
	defer limiter2.Stop()

	fmt.Println("æ¨¡æ‹Ÿ: ç¬é—´å‘é€ 10 ä¸ªè¯·æ±‚ï¼ˆåªæœ‰å‰å‡ ä¸ªèƒ½é€šè¿‡ï¼‰...")

	// TODO(human): ä½¿ç”¨ Allow() æ–¹æ³•
	// å¦‚æœè¿”å› trueï¼Œæ‰§è¡Œè¯·æ±‚
	// å¦‚æœè¿”å› falseï¼Œæ‹’ç»è¯·æ±‚
	//
	// æç¤º:
	// accepted := 0
	// rejected := 0
	// for i := 1; i <= 10; i++ {
	//     if limiter2.Allow() {
	//         callAPI(i)
	//         accepted++
	//     } else {
	//         fmt.Printf("  âŒ [è¯·æ±‚ %2d] è¢«é™æµæ‹’ç»\n", i)
	//         rejected++
	//     }
	//     time.Sleep(50 * time.Millisecond) // æ¨¡æ‹Ÿè¯·æ±‚é—´éš”
	// }

	// ä½ çš„ä»£ç ï¼š

	// TODO(human): æ‰“å°ç»Ÿè®¡
	// fmt.Printf("\né€šè¿‡: %d, æ‹’ç»: %d\n", accepted, rejected)

	fmt.Println()
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("ğŸ’¡ æ€»ç»“:")
	fmt.Println("  â€¢ Wait() é€‚åˆ: å¿…é¡»æ‰§è¡Œæ‰€æœ‰è¯·æ±‚ï¼Œè‡ªåŠ¨é™é€Ÿ")
	fmt.Println("  â€¢ Allow() é€‚åˆ: å¯ä»¥æ‹’ç»è¯·æ±‚ï¼Œå¿«é€Ÿå¤±è´¥")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

	// ğŸ’¡ æ€è€ƒé¢˜:
	// 1. ä¸ºä»€ä¹ˆéœ€è¦ "çªå‘å®¹é‡" (burst size)ï¼Ÿ
	// 2. Wait() å’Œ Allow() åˆ†åˆ«é€‚åˆä»€ä¹ˆåœºæ™¯ï¼Ÿ
	// 3. åœ¨çœŸå®é¡¹ç›®ä¸­ï¼Œé™æµå™¨é€šå¸¸æ”¾åœ¨å“ªé‡Œï¼Ÿï¼ˆæç¤ºï¼šä¸­é—´ä»¶ã€ç½‘å…³ï¼‰
	// 4. è¿™ä¸ªå®ç°æœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿï¼ˆæç¤ºï¼šé‡å¯åä»¤ç‰Œä¼šé‡ç½®ï¼‰
}
